---
import WebsiteLayout from '../layouts/WebsiteLayout.astro';
---
<WebsiteLayout>
  <main class="max-w-3xl mx-auto px-6 pt-10">
    <div class="flex border-b border-gray-300 mb-6">
      <button
        class="px-4 py-2 text-sm font-medium border-b-2 border-black"
      >
        Write
      </button>
      <button
        class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-black"
      >
        Import
      </button>
    </div>
    <form id="postForm" class="space-y-8">
      <input
        type="text"
        name="title"
        placeholder="Title"
        required
        class="w-full text-3xl font-bold placeholder-gray-500 bg-transparent border-none outline-none"
      />
      <textarea
        name="content"
        placeholder="Write your post here..."
        rows="12"
        required
        class="w-full text-lg leading-relaxed placeholder-gray-500 bg-transparent border-none outline-none resize-y"
      ></textarea>
      <div class="flex justify-end gap-4 pt-4">
        <button
          type="button"
          class="px-4 py-2 border rounded transition"
          style="background-color: #fff4ec; border-color: #fff4ec;"
          onmouseover="this.style.backgroundColor='#ffe0c0'"
          onmouseout="this.style.backgroundColor='#fff4ec'"
        >
          Save Draft
        </button>
        <button
          type="submit"
          class="px-4 py-2 border rounded transition bg-blue-500 text-white hover:bg-blue-600"
        >
          Publish
        </button>
      </div>
    </form>
  </main>
</WebsiteLayout>

<script type="module">
  const form = document.getElementById('postForm');
  const status = document.getElementById('status');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    status.textContent = 'Checking login...';

    const loginRes = await fetch('/api/auth/logged-in');
    if (!loginRes.ok) {
      status.textContent = 'You must be logged in to post.';
      return;
    }

    const { user } = await loginRes.json();

    const formData = new FormData(form);
    const post = {
      title: formData.get('title'),
      content: formData.get('content'),
      userId: user.id,
      username: user.user_metadata.username,
    };

    status.textContent = 'Saving post...';

    const saveRes = await fetch('/api/auth/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(post),
    });

    if (saveRes.ok) {
      status.textContent = 'Post saved!';
      form.reset();
    } else {
      const err = await saveRes.json();
      status.textContent = 'Error saving post: ' + (err.message || 'Unknown error');
    }
  });
</script>