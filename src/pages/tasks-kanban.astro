---
import HeaderWhite from '../components/HeaderWhite.astro';
import Analytics from '@vercel/analytics/astro';
import SpeedInsights from '@vercel/speed-insights/astro';

let tasks: any[] = [];

const cookie = Astro.request.headers.get('cookie') || '';
try {
  const res = await fetch(`${import.meta.env.PUBLIC_API_URL}api/tasks`, {
    headers: { cookie }
  });
  const data = await res.json();
  tasks = data.tasks || [];
} catch (e) {
  tasks = [];
}

// Group tasks by status
const tasksByStatus = {
  'To Do': tasks.filter(t => t.status === 'To Do'),
  'In Progress': tasks.filter(t => t.status === 'In Progress'),
  'Done': tasks.filter(t => t.status === 'Done'),
};
---

<HeaderWhite />
<main class="kanban-main">
  <div class="kanban-header">
    <h1 class="kanban-title">Task Board</h1>
    <div class="kanban-actions">
      <a href="/dashboard" class="kanban-link">Dashboard</a>
      <a href="/master-tracker" class="kanban-link">Table View</a>
    </div>
  </div>

  <div class="kanban-container">
    <div class="kanban-column" data-status="To Do">
      <div class="kanban-column-header">
        <h2>To Do</h2>
        <span class="kanban-count">{tasksByStatus['To Do'].length}</span>
      </div>
      <div class="kanban-cards" id="todo-cards">
        {tasksByStatus['To Do'].map((task) => (
          <div class="kanban-card" data-task-id={task.id} data-status="To Do">
            <div class="kanban-card-header">
              <h3 class="kanban-card-title">{task.item}</h3>
              <span class="kanban-card-class">{task.class}</span>
            </div>
            <div class="kanban-card-body">
              {task.type && <div class="kanban-card-meta"><strong>Type:</strong> {task.type}</div>}
              <div class="kanban-card-meta">
                <strong>Due:</strong> {new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
              </div>
              {task.est_time && (
                <div class="kanban-card-meta">
                  <strong>Est. Time:</strong> {task.est_time}h
                  {task.time_left !== null && task.time_left !== undefined && (
                    <span class="kanban-time-left"> ({task.time_left}h left)</span>
                  )}
                </div>
              )}
            </div>
            <div class="kanban-card-footer">
              <a href={`/tasks/${task.id}`} class="kanban-card-link">View Details</a>
              <div class="kanban-card-actions">
                <button class="kanban-move-btn" data-task-id={task.id} data-target="In Progress">→</button>
                <button class="kanban-move-btn" data-task-id={task.id} data-target="Done">✓</button>
              </div>
            </div>
          </div>
        ))}
        {tasksByStatus['To Do'].length === 0 && (
          <div class="kanban-empty">No tasks</div>
        )}
      </div>
    </div>

    <div class="kanban-column" data-status="In Progress">
      <div class="kanban-column-header">
        <h2>In Progress</h2>
        <span class="kanban-count">{tasksByStatus['In Progress'].length}</span>
      </div>
      <div class="kanban-cards" id="progress-cards">
        {tasksByStatus['In Progress'].map((task) => (
          <div class="kanban-card" data-task-id={task.id} data-status="In Progress">
            <div class="kanban-card-header">
              <h3 class="kanban-card-title">{task.item}</h3>
              <span class="kanban-card-class">{task.class}</span>
            </div>
            <div class="kanban-card-body">
              {task.type && <div class="kanban-card-meta"><strong>Type:</strong> {task.type}</div>}
              <div class="kanban-card-meta">
                <strong>Due:</strong> {new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
              </div>
              {task.est_time && (
                <div class="kanban-card-meta">
                  <strong>Est. Time:</strong> {task.est_time}h
                  {task.time_left !== null && task.time_left !== undefined && (
                    <span class="kanban-time-left"> ({task.time_left}h left)</span>
                  )}
                </div>
              )}
            </div>
            <div class="kanban-card-footer">
              <a href={`/tasks/${task.id}`} class="kanban-card-link">View Details</a>
              <div class="kanban-card-actions">
                <button class="kanban-move-btn" data-task-id={task.id} data-target="To Do">←</button>
                <button class="kanban-move-btn" data-task-id={task.id} data-target="Done">✓</button>
              </div>
            </div>
          </div>
        ))}
        {tasksByStatus['In Progress'].length === 0 && (
          <div class="kanban-empty">No tasks</div>
        )}
      </div>
    </div>

    <div class="kanban-column" data-status="Done">
      <div class="kanban-column-header">
        <h2>Done</h2>
        <span class="kanban-count">{tasksByStatus['Done'].length}</span>
      </div>
      <div class="kanban-cards" id="done-cards">
        {tasksByStatus['Done'].map((task) => (
          <div class="kanban-card kanban-card-done" data-task-id={task.id} data-status="Done">
            <div class="kanban-card-header">
              <h3 class="kanban-card-title">{task.item}</h3>
              <span class="kanban-card-class">{task.class}</span>
            </div>
            <div class="kanban-card-body">
              {task.type && <div class="kanban-card-meta"><strong>Type:</strong> {task.type}</div>}
              <div class="kanban-card-meta">
                <strong>Due:</strong> {new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
              </div>
            </div>
            <div class="kanban-card-footer">
              <a href={`/tasks/${task.id}`} class="kanban-card-link">View Details</a>
              <div class="kanban-card-actions">
                <button class="kanban-move-btn" data-task-id={task.id} data-target="To Do">←</button>
              </div>
            </div>
          </div>
        ))}
        {tasksByStatus['Done'].length === 0 && (
          <div class="kanban-empty">No tasks</div>
        )}
      </div>
    </div>
  </div>
</main>

<style>
  body {
    background: #f5f7fa;
    color: #1a1a1a;
  }

  .kanban-main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
  }

  .kanban-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .kanban-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #0f172a;
    margin: 0;
  }

  .kanban-actions {
    display: flex;
    gap: 0.75rem;
  }

  .kanban-link {
    padding: 0.5rem 1rem;
    background: #fff;
    border: 1px solid #d1d5db;
    color: #374151;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .kanban-link:hover {
    background: #f9fafb;
    border-color: #9ca3af;
  }

  .kanban-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    align-items: start;
  }

  .kanban-column {
    background: #f9fafb;
    border-radius: 8px;
    padding: 1rem;
    min-height: 400px;
    border: 1px solid #e5e7eb;
  }

  .kanban-column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .kanban-column-header h2 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
  }

  .kanban-count {
    background: #e5e7eb;
    color: #6b7280;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .kanban-cards {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .kanban-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 1rem;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .kanban-card:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
    border-color: #cbd5e1;
  }

  .kanban-card-done {
    opacity: 0.7;
    background: #f9fafb;
  }

  .kanban-card-header {
    margin-bottom: 0.75rem;
  }

  .kanban-card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #0f172a;
    margin: 0 0 0.25rem 0;
    line-height: 1.4;
  }

  .kanban-card-class {
    font-size: 0.85rem;
    color: #6b7280;
    font-style: italic;
  }

  .kanban-card-body {
    margin-bottom: 0.75rem;
  }

  .kanban-card-meta {
    font-size: 0.85rem;
    color: #4b5563;
    margin-bottom: 0.4rem;
  }

  .kanban-card-meta strong {
    color: #374151;
    font-weight: 600;
  }

  .kanban-time-left {
    color: #dc2626;
    font-weight: 500;
  }

  .kanban-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    border-top: 1px solid #f3f4f6;
  }

  .kanban-card-link {
    color: #2563eb;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .kanban-card-link:hover {
    text-decoration: underline;
  }

  .kanban-card-actions {
    display: flex;
    gap: 0.5rem;
  }

  .kanban-move-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
    font-weight: 600;
  }

  .kanban-move-btn:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
  }

  .kanban-empty {
    text-align: center;
    color: #9ca3af;
    font-style: italic;
    padding: 2rem 1rem;
    font-size: 0.9rem;
  }

  @media (max-width: 1024px) {
    .kanban-container {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .kanban-main {
      padding: 1rem 0.5rem;
    }

    .kanban-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .kanban-actions {
      width: 100%;
      flex-wrap: wrap;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const moveButtons = document.querySelectorAll('.kanban-move-btn');
    
    moveButtons.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const button = e.target as HTMLButtonElement;
        const taskId = button.getAttribute('data-task-id');
        const targetStatus = button.getAttribute('data-target');
        
        if (!taskId || !targetStatus) return;

        try {
          const res = await fetch('/api/tasks/status_change', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: taskId, status: targetStatus, _update: true })
          });

          if (res.ok) {
            // Reload the page to show updated state
            window.location.reload();
          } else {
            const error = await res.json();
            alert('Error: ' + (error.error || 'Failed to update task'));
          }
        } catch (err) {
          alert('Error: Failed to update task');
          console.error(err);
        }
      });
    });
  });
</script>

<Analytics />
<SpeedInsights />
